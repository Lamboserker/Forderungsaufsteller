<!DOCTYPE html>
<html>
  <head>
    <title>Case Numbers and Claims</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <h1 class="header-primary">Case Numbers and Claims</h1>
      <form id="claimForm">
        <label for="caseNumber">Case Number:</label>
        <input type="text" id="caseNumber" required /><br />

        <label for="amount">Amount of Claim:</label>
        <input type="number" id="amount" step="0.01" required /><br />

        <label for="creditorName">Name of the creditor:</label>
        <input type="text" id="creditorName" required /><br />

        <label for="deadlineDate">Deadline:</label>
        <input type="date" id="deadlineDate" required /><br />

        <button type="submit">Add/Update</button>
      </form>

      <h2>Saved Claims</h2>
      <ul id="claimList">
        <!-- List items will be populated here -->
      </ul>

      <button id="emailButton" class="btn btn-primary">Generate Email</button>
    </div>
    <script>
      let totalAmount = 0;
      let claims = [];

      function generateEmailBody(claims, creditorName, deadlineDate) {
        let emailBody = "Vorschlag für Ratenzahlungsvereinbarung\n";
        emailBody += "---------------------------------\n";
        emailBody += `An: ${creditorName}\n`;
        emailBody += `Datum: ${new Date().toLocaleDateString("de-DE")}\n`;
        emailBody += "---------------------------------\n\n";

        emailBody += "Betreffende Forderungen:\n";
        claims.forEach((claim) => {
          emailBody += `Fallnummer: ${claim.caseNumber}, Betrag: €${claim.amount}\n`;
        });

        emailBody += "\n---------------------------------\n";
        emailBody += `Gesamtschuld: €${totalAmount.toFixed(2)}\n`;

        let suggestedPayment = (totalAmount / 12).toFixed(2);
        if (parseFloat(suggestedPayment) > 200) {
          suggestedPayment = "200.00";
        }

        emailBody += `Vorgeschlagene monatliche Rate: €${suggestedPayment}\n`;
        emailBody += "---------------------------------\n";
        emailBody +=
          "Ich schlage vor, die oben genannten Beträge in monatlichen Raten zu begleichen.\n";
        emailBody +=
          "Bitte bestätigen Sie diese Vereinbarung bis zum " +
          deadlineDate +
          ".\n";

        return emailBody;
      }

      async function deleteClaim(caseNumber) {
        const confirmDelete = window.confirm(
          "Are you sure you want to delete this claim?"
        );
        if (!confirmDelete) return;

        const response = await fetch("http://localhost:3000/api/claims", {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ caseNumber }),
        });

        if (response.ok) {
          fetchClaims();
        }
      }

      async function fetchClaims() {
        const response = await fetch("http://localhost:3000/api/claims");
        const data = await response.json();
        claims = data;

        const ul = document.getElementById("claimList");
        ul.innerHTML = "";

        totalAmount = 0;

        data.forEach((claim) => {
          const li = document.createElement("li");
          li.textContent = `Case Number: ${claim.caseNumber}, Amount: €${claim.amount}`;

          const deleteBtn = document.createElement("button");
          deleteBtn.innerHTML = "&#128465;";
          deleteBtn.style.color = "red";
          deleteBtn.style.float = "right";
          deleteBtn.addEventListener("click", () =>
            deleteClaim(claim.caseNumber)
          );

          li.appendChild(deleteBtn);

          ul.appendChild(li);

          totalAmount += parseFloat(claim.amount);
        });
      }

      fetchClaims();

      document
        .getElementById("claimForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const caseNumber = document.getElementById("caseNumber").value;
          const amount = parseFloat(
            document.getElementById("amount").value
          ).toFixed(2);

          const existingClaim = claims.find((c) => c.caseNumber === caseNumber);
          if (
            existingClaim &&
            parseFloat(existingClaim.amount) >= parseFloat(amount)
          ) {
            alert(
              "The entered amount must be higher than the current amount for the given case number."
            );
            return;
          }

          const response = await fetch("http://localhost:3000/api/claims", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ caseNumber, amount }),
          });

          if (response.ok) {
            fetchClaims();
          }
        });

      document.getElementById("emailButton").addEventListener("click", () => {
        const creditorName = document.getElementById("creditorName").value;
        const deadlineDate = document.getElementById("deadlineDate").value;

        const emailSubject = "Vorschlag für Ratenzahlungsvereinbarung";
        let emailBody = generateEmailBody(claims, creditorName, deadlineDate);

        let suggestedPayment = (totalAmount / 12).toFixed(2);
        if (parseFloat(suggestedPayment) > 200) {
          suggestedPayment = "200.00";
        }

        emailBody += `\nTotal Amount: €${totalAmount.toFixed(2)}\n`;
        emailBody += `Suggested Monthly Payment: €${suggestedPayment}\n`;

        window.location.href = `mailto:?subject=${encodeURIComponent(
          emailSubject
        )}&body=${encodeURIComponent(emailBody)}`;
      });
    </script>
  </body>
</html>
